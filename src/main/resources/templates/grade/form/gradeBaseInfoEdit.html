<!-- jQuery 3 -->
<script type="text/javascript" src="${ctxPath}/frame/jquery/jquery-3.4.1.js"></script>
<!-- vue -->
<script type="text/javascript" src="${ctxPath}/frame/vue/vue.min.js"></script>
<!-- layui -->
<script src="${ctxPath}/frame/layui-v2.5.7/layui/layui.js"></script>
<link rel="stylesheet" href="${ctxPath}/frame/layui-v2.5.7/layui/css/layui.css">

<!-- 添加/修改年级基本信息-->
<div style="padding-top: 20px;">
    <p id="actionTag" hidden>${action}</p>
    <div id="gradeEditModal">
        <form class="layui-form" action="" lay-filter="gradeEditForm">
            <div class="layui-form-item">
                <label class="layui-form-label">年级名称</label>
                <div class="layui-input-block" style="width: 45%;">
                    <input type="text" name="gradeName" required lay-verify="required|name" placeholder="年级名称" autocomplete="off"
                           class="layui-input" v-model="gradeName">
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">年级类型</label>
                    <div class="layui-input-inline"><select name="gradeType" lay-verify="required" lay-search="" id="gradeTypeSelect" lay-filter="gradeTypeSelect">
                        <option value="">年级类型列表</option>
                        <option v-for="gradeType in gradeTypeList" :value="gradeType.typeCode">{{gradeType.typeDescription}}</option>
                    </select></div>

                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">年级主任</label>
                    <div class="layui-input-inline">
                        <select name="teacherId" lay-verify="required" lay-search="" id="teacherSelect" lay-filter="teacherSelect"
                                >
                            <option value="">获取教师列表</option>
                            <option v-for="teacher in teacherList" :value="teacher.id">{{teacher.name}} - {{teacher.id}}</option>
                        </select>
                    </div>

                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">入学时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="enterStudyTime" id="enterStudyTime" required lay-verify="date|required"
                               placeholder="该年级入学时间" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">毕业时间</label>
                    <div class="layui-input-inline">
                        <input type="text" name="endStudyTime" id="endStudyTime" required lay-verify="date|required"
                               placeholder="该年级毕业时间" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;margin-bottom: 30px;">
                <legend></legend>
            </fieldset>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block" style="width: 500px;">
                    <textarea name="remark" placeholder="请输入内容" class="layui-textarea" v-model="remark"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="gradeEdit" >立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function child(grade) {
        var formVue = new Vue({
            el: "#gradeEditModal",
            data : {
                form : null,
                actionType : null,
                gradeTypeList : null,
                gradeType : null,
                teacherList : null,
                teacher : null,
                gradeName : "",
                //gradeType : "",
                teacherId : "",
                enterStudyTime : "",
                endStudyTime : "",
                remark : "",
            },
            methods : {
                getGradeTypeList : function () {
                    $.get("${ctxPath}/happy-study/studentMan/list/gradeType", {}, response=>{
                        var state = response.state;
                        if (state==0){
                            console.log(response.description);
                            return ;
                        }
                        this.gradeTypeList = response.resData;
                        //debugger
                    })
                },
                getTeacherList : function(){
                    $.ajax({
                        url : "${ctxPath}/happy-study/gradeMan/editdata/baseinfo/listGradeMasterAbleTeacher",
                        type : 'get',
                        async : false,
                        success : (response)=>{
                            var resData = response.resData;
                            console.log(resData);
                            this.teacherList = resData;
                            //debugger
                        }
                    })
                },
                loadGrade : function (grade) {
                    if (grade!=undefined && grade!=null){
                        this.gradeName = grade.gradeName;
                        this.gradeType = grade.gradeType;
                        this.teacher = {
                            id : grade.gradeMasterId,
                            name : grade.gradeMasterName,
                        };
                        this.enterStudyTime = grade.enterStudyTime;
                        this.endStudyTime = grade.endStudyTime;
                        this.remark = grade.remark;
                        debugger
                    }
                }
            },
            mounted : function () {
                this.actionType = $("#actionTag").text();
                console.log(this.actionType);

                this.getGradeTypeList();
                this.getTeacherList();
                this.loadGrade(grade);
            }
        })

        function renderForm() {
            layui.use('form', function () {
                var form = layui.form;
                form.render();
            })
        }

        layui.use(['form', 'layedit', 'laydate'], function () {
            var form = layui.form
                ,layer = layui.layer
                ,layedit = layui.layedit
                ,laydate = layui.laydate;

            formVue.form = form;

            //入学/毕业日期
            laydate.render({
                elem : "#enterStudyTime",
                trigger : "click",
                done : function (value, date, endDate) {
                    formVue.enterStudyTime = value;
                }
            })
            laydate.render({
                elem : "#endStudyTime",
                trigger : "click",
                done : function (value, date, endDate) {
                    formVue.endStudyTime = value;
                }
            })

            //注册select框
            form.on('select(gradeTypeSelect)', function(data){
                formVue.gradeType = data.value;
                form.render();
            })
            form.on('select(teacherSelect)', function (data) {
                formVue.teacherId = data.value;
                var teacherList = formVue.teacherList;
                for (var i = 0; i < teacherList.length; i++){
                    if (teacherList[i].id==formVue.teacherId){
                        formVue.teacher = teacherList[i];
                    }
                }
                form.render();
            })

            form.on("submit(gradeEditForm)", function(data){
                var gradeName = formVue.gradeName;
                var gradeType = formVue.gradeType;
                var teacherId = formVue.teacherId;
                var enterStudyTime = formVue.enterStudyTime;
                var endStudyTime = formVue.endStudyTime;
                var remark = formVue.remark;

                var dataParam = {
                    gradeName : gradeName,
                    gradeType : gradeType,
                    gradeMasterId : teacherId,
                    enterStudyTime : enterStudyTime,
                    endStudyTime : endStudyTime,
                    remark : remark,
                }

                $.ajax({
                    url : "${ctxPath}/happy-study/gradeMan/doEdit/baseinfo/"+formVue.actionType,
                    type : "post",
                    data : JSON.stringify(dataParam),
                    contentType : "application/json;charset=utf-8",
                    async : false,
                    success : response=>{
                        layer.msg(response.description, {
                            end : function(){

                            }
                        })

                        setTimeout(()=>{
                            parent.layer.closeAll('iframe');
                        }, 1500)
                    },
                    error : ()=>{
                        layer.msg("请求失败", {icon : 5});
                    }
                })

                return false;
            })

            form.verify({
                name: function(value){
                    if(value.length < 2){
                        return '名字至少2字';
                    }
                }
                ,pass: [
                    /^[\S]{6,12}$/
                    ,'密码必须6到12位，且不能出现空格'
                ]

            })
        })
    }

</script>