

<style>
    .myTbhead {
        background: #393D49;
        color: #F0F0F0;
    }
    .man-container {
        margin-top: 10px;
    }
    .reload :hover{
        font-size: 32px;
        color: #95999c;
    }
    .orderTagPane {
        width: 16px;
        height: 100%;
        padding-top: 1%;
        padding-bottom: 1%;
    }
</style>

<div id="student-man" class="container-fluid man-container" style="margin-left: 0px;margin-right: 0px;">
    <!-- 表头按钮 -->
    <div class="row" style="width: 100%;">
        <div class="col" style="padding-right: 8px; padding-left: 0px;">
            <input type="text" name="title" required lay-verify="required" placeholder="按姓名/学号搜索" autocomplete="off"
                   class="layui-input" id="filterInput" v-model="pageParam.filter.keyword">
        </div>
        <div class="col row">
            <div class="col" style="padding-left: 8px; padding-right: 4px;">
                <form class="layui-form layui-inline">
                    <select name="sex" lay-search="" id="sexSelect" lay-filter="sexSelect">
                        <option value="">性别</option>
                        <option value="0">男</option>
                        <option value="1">女</option>
                    </select>
                </form>
            </div>
            <div class="col" style="padding-left: 4px; padding-right: 8px">
                <form class="layui-form layui-inline">
                    <select name="gradeType" lay-search="" id="gradeTypeSelect" lay-filter="gradeTypeSelect">
                        <option v-if="gradeType.typeCode==''" value="">初中/高中</option>
                        <option v-if="gradeType.typeCode!=''" :value="gradeType.typeCode">{{gradeType.typeDescription}}</option>
                        <option v-for="type in gradeTypeArray" :value="type.typeCode">{{type.typeDescription}}</option>
                    </select>
                </form>
            </div>
            <div class="col" style="padding-left: 4px; padding-right: 8px">
                <form class="layui-form layui-inline">
                    <select name="grade"lay-search=""  id="gradeSelect" lay-filter="gradeSelect">
                        <option value="">年级</option>
                        <option v-for="grade in gradeArray" :value="grade.id">{{grade.gradeName}}</option>
                    </select>
                </form>
            </div>
        </div>
        <div class="col">
            <button class="layui-btn" @click="selectIt">搜索</button>
        </div>

        <div class="col">
            <div class=" row" style="float:right;">
                <button class="layui-btn col" @click="excelImport()">导入</button>
                <button class="layui-btn col" @click="openStuEditModal('add', null)">添加</button>
                <button class="layui-btn layui-btn-danger col" @click="deleteBatch()">删除</button>
            </div>
        </div>
    </div>

    <!-- 表格 -->
    <div id="tablePane" class="row" style="width: 100%;">
        <div class="col-xl-12" style="padding: 0px;">
            <table class="layui-table" id="dataTable">
                <colgroup>
                    <col width="50">
                    <col width="150">
                    <col width="150">
                    <col width="150">
                    <col width="150">
                    <col width="150">
                    <col width="150">
                    <col width="150">
                    <col width="150">
                    <col>
                    <col width="150">
                </colgroup>
                <thead class="myTbhead">
                <tr>
                    <th class="myTbhead" id="headCheck">
                        <input type="checkbox" name="" lay-skin="primary" id="checkAll" style="text-align: center;" class="layui-form-checkbox"
                               v-model="stuCheck.isCheckAll" @change="checkAll()"></th>
                    <th class="myTbhead">学号
                        <button class="btn btn-dark btn-sm" style="height: 40%;" @click="orderIt('sNo', 'asc')"><i class="bi bi-arrow-up-short" style="height: 100%;"></i></button>
                        <button class="btn btn-dark btn-sm" style="height: 40%;" @click="orderIt('sNo', 'desc')"><i class="bi bi-arrow-down-short" style="height: 100%;"></i></button></th>
                    <th class="myTbhead">姓名
                        <button class="btn btn-dark btn-sm" style="height: 40%;" @click="orderIt('name', 'asc')"><i class="bi bi-arrow-up-short" style="height: 100%;"></i></button>
                        <button class="btn btn-dark btn-sm" style="height: 40%;" @click="orderIt('name', 'desc')"><i class="bi bi-arrow-down-short" style="height: 100%;"></i></button></th>
                    <th class="myTbhead">性别
                        <button class="btn btn-dark btn-sm" style="height: 40%;" @click="orderIt('sex', 'asc')"><i class="bi bi-arrow-up-short" style="height: 100%;"></i></button>
                        <button class="btn btn-dark btn-sm" style="height: 40%;" @click="orderIt('sex', 'desc')"><i class="bi bi-arrow-down-short" style="height: 100%;"></i></button></th>
                    <th class="myTbhead">年龄
                        <button class="btn btn-dark btn-sm" style="height: 40%;" @click="orderIt('birthday', 'asc')"><i class="bi bi-arrow-up-short" style="height: 100%;"></i></button>
                        <button class="btn btn-dark btn-sm" style="height: 40%;" @click="orderIt('birthday', 'desc')"><i class="bi bi-arrow-down-short" style="height: 100%;"></i></button></th>
                    <th class="myTbhead">所在班级</th>
                    <th class="myTbhead">班主任</th>
                    <th class="myTbhead">所在年级</th>
                    <th class="myTbhead">年级主任</th>
                    <th class="myTbhead">备注</th>
                    <th class="myTbhead">编辑</th>
                </tr>
                </thead>
                <tbody v-for="student in stuBaseInfo.infoArray">
                <tr>
                    <td><input type="checkbox" name="" lay-skin="primary" class="layui-form-checkbox"
                               v-model="stuCheck.checkedValues" :value="student.id"></td>
                    <td><a href="#" @click="openBTModal(student)">{{student.sno}}</a></td>
                    <td>{{student.name}}</td>
                    <td>{{student.sex}}</td>
                    <td>{{student.age}}</td>
                    <td>{{student.clazzName}}</td>
                    <td>{{student.clazzMasterName}}</td>
                    <td>{{student.gradeName}}</td>
                    <td>{{student.gradeMasterName}}</td>
                    <td v-if="student.remark!=null&&student.remark!=''">{{student.remark}}</td>
                    <td v-if="student.remark==null||student.remark==''">暂无</td>
                    <td>
                        <button class="layui-btn layui-btn-sm" style="float: left;margin-left: 5%;"
                                @click="openStuEditModal('update', student)">修改</button>
                        <button class="layui-btn layui-btn-sm layui-btn-danger" style="float: right;margin-right: 5%;"
                                @click="deleteConfirm(student)">删除</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="navPane" class="row" style="width: 100%;">
        <div class="col d-flex justify-content-center">
            <nav aria-label="Page navigation" id="nav" class="d-flex align-items-center">
                <ul class="pagination d-flex align-items-center" style="margin-bottom: 0px;">
                    <li class="page-item">
                        <a class="page-link" href="javascript://" @click="goToPage(1)">首页</a>
                    </li>
                    <li class="page-item" v-bind:class="{ 'disabled' : pageParam.currentPage==1 }">
                        <a class="page-link" href="#" :aria-disabled="pageParam.currentPage==1"
                           @click="goToPage(--pageParam.currentPage)">上一页</a>
                    </li>
                    <li class="page-item disabled">
                        <a class="page-link" href="#" aria-disabled="true"
                           v-show="stuBaseInfo.pageBeforeOmit">...</a>
                    </li>

                    <li class="page-item" v-for="i in pageParam.pageCount" v-bind:class="{'active' : i==pageParam.currentPage}"
                        ><a class="page-link" href="#" @click="goToPage(i)">{{i}} <span class="sr-only" v-if="i==pageParam.currentPage">(current)</span></a></li>

                    <li class="page-item disabled">
                        <a class="page-link" href="#" aria-disabled="true"
                           v-show="stuBaseInfo.pageAfterOmit">...</a>
                    </li>
                    <li class="page-item" v-bind:class="{ 'disabled' : pageParam.currentPage==pageParam.pageCount }">
                        <a class="page-link" href="#" :aria-disabled="pageParam.currentPage==pageParam.pageCount"
                           @click="goToPage(++pageParam.currentPage)">下一页</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="javascript://" @click="goToPage(pageParam.pageCount)">尾页</a>
                    </li>
                </ul>
            </nav>
            <!-- 每页大小 -->
            <div style="padding-left: 8px;">
                <form class="form-inline">
                    <label class="my-1 mr-2" for="pageSizeBox">每页大小</label>
                    <select class="custom-select my-1 mr-sm-2" id="pageSizeBox" @change="setPageSize()">
                        <option v-for="pageSize in pageParam.pageSizeList" :value="pageSize">{{pageSize}}</option>
                    </select>

                    <a href="javascript://" class="reload" style="font-size: 26px; color: #3c3c3c;" @click="goToPage(1)">
                        <i class="bi bi-arrow-repeat d-flex align-items-center" ></i>
                    </a>
                    <p class="text-monospace d-flex align-items-center" style="margin-bottom: 0px;">共 {{pageParam.totalCount}} 条数据</p>
                </form>

            </div>
        </div>

        <!-- excel导入 -->
        <div v-show="false">
            <form id="import_stu_form"  enctype="multipart/form-data" method="post" action="" v-show="false">
                <div style="margin-top: 5px" v-show="false">
                    选择Excel文件：<input type="file" id="stu_excel" name="excel" @change="doExcelImport"
                                     accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" /></div>
            </form>
        </div>


    </div>

    <!-- Button trigger modal -->
    <button type="button" id="modalTrigger" class="btn btn-primary" data-toggle="modal" data-target="#common-modal" hidden>
        Launch demo modal
    </button>


</div>




<script>
    var vue = new Vue({
        el : "#student-man",
        data : {
            stuBaseInfo : {
                infoArray : null,
                select : "",
                pageBeforeOmit : false,
                pageAfterOmit : true,
            },
            stuEditModal : {
                show : false,
                actionType : "add", //add添加 update更新
            },
            gradeTypeArray : null,
            gradeArray : null,
            page : {
                current : 1,
            },
            tableActive : null,
            stuCheck : {
                isCheckAll : false,
                checkedValues : [],
            },
            pageParam : {
                currentPage : 1,
                pageSize : 5,
                pageSizeList : [5, 10, 20, 50],
                pageCount : 0,
                totalCount : 0,
                pageBuffer : [],
                pageBeforeOmit : false,
                pageAffterOmit : true,
                orderBy : "",
                orderWay : "asc",
                filter : {
                    gradeType : "",
                    gradeId : "",
                    sex : "",
                    keyword : "",
                },
                ext : [],
                isFirstTime : true,
            },
            layUI : {
                laypage : null,
            },
            gradeType : {
                typeCode : "",
                typeDescription : "",
            },

        },
        methods : {
            orderIt : function(orderBy, orderWay){
                this.pageParam.orderBy = orderBy;
                this.pageParam.orderWay = orderWay;
                this.listForm();
            },
            selectIt : function(){
                var keyword = this.pageParam.filter.keyword;
                var gradeType = this.pageParam.filter.gradeType;
                var gradeId = this.pageParam.filter.gradeId
                var sex = this.pageParam.filter.sex;

                if (keyword !=undefined && keyword != null && keyword != ""){
                    this.pageParam.ext[0] = keyword;
                    this.pageParam.ext.push("test");
                }

                this.listForm();
            },
            openBTModal : function(student){
                var url = "${ctxPath}/happy-study/studentMan/showStuMsg"
                var loading = vue.loadingFont;
                $("#common-modal-head").text(student.name);
                $("#common-modal-body").empty();
                $("#modalTrigger").trigger("click");
                $("#common-modal-body").html(loading);
                debugger;
                $("#common-modal-body").load(url, {student}, function () {
                    modalVue.student = student;
                });
            },
            doExcelImport : function(){
                if ($("#stu_excel").val()==""){
                    return ;
                }
                var formData = new FormData($("#import_stu_form")[0]);
                formData.append("file", $("#stu_excel")[0].files);

                $.ajax({
                    type : "post",
                    url : "${ctxPath}/happy-study/studentMan/import",
                    processData : false,
                    contentType : false,
                    data : formData,
                    success : response=>{
                        if (response.state == 2){
                            layer.msg(response.description, {
                                icon : 3
                            });

                        }else if (response.state == 1){
                            vue.listForm();
                            layer.msg(response.description, {
                                end : function () {
                                },
                                icon : 1
                            });

                        }else{
                            layer.msg(response.description, {
                                icon : 7
                            })

                        }
                        $("#stu_excel").val("");
                        return ;
                    },
                    error : function (err) {
                        layer.msg(err, {
                            icon : 7
                        })
                        $("#stu_excel").val("");
                        return ;
                    }
                })
            },
            excelImport : function(){
                $("#stu_excel").trigger("click");
            },
            setPageSize : function(){
                if (this.pageParam.pageSize == $("#pageSizeBox").val()){
                    return ;
                }
                this.pageParam.pageSize = $("#pageSizeBox").val();
                this.pageParam.currentPage = 1;

                this.listForm();

            },
            goToPage : function(page){
                if (page == 1){

                }
                if (page==this.pageParam.pageCount){
                    $("")
                }
                if (page < 1){
                    alert("第一页了");
                    return ;
                }
                if (page > this.pageParam.pageCount){
                    alert("已经到底了");
                    return ;
                }
                this.pageParam.currentPage = page;
                this.listForm();
            },
            deleteBatch : function(){
                checkedValues = this.stuCheck.checkedValues;
                if (checkedValues == undefined || checkedValues == null || checkedValues.length == 0){
                    layer.msg("还未勾选删除的学生", {
                        icon : 3
                    });
                    return ;
                }

                var ids = "";
                for (var i = 0; i < checkedValues.length; i++){
                    ids += checkedValues[i]+"-";
                }
                var msg = "确认要删除学生 "+checkedValues.length+" 个 吗？"
                layer.confirm(msg, {
                    btn:['确定', '取消']
                }, function (index) {
                    layer.close(index);
                    vue.deleteSome(ids);
                }, function () {
                    alert("2");
                })
            },
            checkAll : function(){
                var array = this.stuBaseInfo.infoArray;
                //debugger
                if (array != null){
                    if (this.stuCheck.isCheckAll){
                        this.stuCheck.checkedValues = [];
                        for (var i = 0; i < array.length; i++){
                            this.stuCheck.checkedValues.push(array[i].id);
                        }
                    }else {
                        this.stuCheck.checkedValues = [];
                    }
                }
            },
            deleteSome : function(studentIdList){
                $.ajax({
                    url : "${ctxPath}/happy-study/studentMan/doEdit/baseinfo/delete",
                    type : "delete",
                    data : {studentIds : studentIdList},
                    async : false,
                    success : (response)=>{
                        if (response.state == 1){
                            vue.listForm();
                            layer.msg(response.description, {
                                end : function () {
                                },
                                icon : 1
                            });
                        }else if (response.state == 2) {
                            vue.listForm();
                            layer.msg(response.description, {
                                icon : 3
                            });
                        }else {
                            layer.msg(response.description, {
                                icon : 7
                            })
                        }
                    },
                    error : ()=>{
                        layer.msg("请求错误", {
                            icon : 2
                        });
                    }
                })
            },
            deleteConfirm : function(student){
                var msg = "确认要删除学生\r\n 学号:"+student.sno+"\r\n 姓名:"+student.name+"\r\n 吗？"
                layer.confirm(msg, {
                    btn:['确定', '取消']
                }, function (index) {
                    layer.close(index);
                    vue.deleteSome(student.id);
                }, function () {
                    //alert("2");
                })

            },
            openStuEditModal : function(actionType, student){
                var modalTitle = "";
                if (actionType == 'add'){
                    this.stuEditModal.actionType = actionType;
                    modalTitle = "添加学生";
                }else if (actionType == 'update'){
                    this.stuEditModal.actionType = actionType
                    modalTitle = "更新学生信息"
                }else{
                    return ;
                }
                layer.open({
                    type: 2,
                    title: modalTitle,
                    //content: $('#stuEditModal'),
                    content: ["${ctxPath}/happy-study/studentMan/editform/baseinfo/"+actionType, "no"], //获取html 不出现滚动条
                    area: ['700px', '700px'],
                    success: function (layero, index) {
                        //弹出成功后的回调
                        vue.stuEditModal.show = true;

                        if (student!=null){
                            if (student.sex=="女"){
                                student.sex = 1;
                            }else{
                                student.sex = 0;
                            }
                        }
                        //像子模块传递，子模块的vue写在这里面的，如果这类不掉用，子模块的vue无法加载
                        //！！！！！！注意！！！！！！
                        var iframe = window['layui-layer-iframe' + index];
                        iframe.child(student);
                        //debugger
                    },
                    end : function () {
                        //弹框销毁后刷新表格
                        vue.listForm();
                    }
                })
            },
            refreshCheckBox : function(){
                this.stuCheck.isCheckAll=false;
                this.stuCheck.checkedValues=[];
                this.stuBaseInfo.infoArray = null;
            },
            listForm : function () {
                this.refreshCheckBox();

                var pageParam = this.pageParam;

                var paginationParam = {
                    page : pageParam.currentPage,
                    pageSize : pageParam.pageSize,
                    orderBy : pageParam.orderBy,
                    orderWay : pageParam.orderWay,
                    totalCount : 0
                }
                var filter = {
                    gradeType : pageParam.filter.gradeType,
                    gradeId : pageParam.filter.gradeId,
                    sex : pageParam.filter.sex
                }
                if (this.stuBaseInfo==undefined){
                    pageParam.ext.push("");
                }else{
                    pageParam.ext.push(this.stuBaseInfo.select);
                }

                var ext = pageParam.ext;

                $.ajax({
                    type : "get",
                    url : "${ctxPath}/happy-study/studentMan/list",
                    async: false,
                    data : {paginationParam : paginationParam,
                        filter : filter,
                        ext : ext},
                    success : (response)=>{
                        var state = response.state;
                        if (state==0){
                            console.log(response.description);
                            return 0;
                        }
                        this.stuBaseInfo.infoArray = response.resData[0].resList;
                        this.pageParam.totalCount = response.resData[0].paginationParam.totalCount;
                        this.pageParam.pageCount = response.resData[0].paginationParam.pageCount;
                        console.log(this.stuBaseInfo.infoArray);
                        this.stuBaseInfo.pageAfterOmit = this.pageParam.pageCount - this.pageParam.currentPage > 3 ? true : false;
                        this.stuBaseInfo.pageBeforeOmit = this.pageParam.currentPage - 1 > 3 ? true : false;

                        return this.pageParam.totalCount;
                    }
                })
                //debugger
            },
            getGradeTypeList : function () {
                $.get("${ctxPath}/happy-study/studentMan/list/gradeType", {}, response=>{
                    var state = response.state;
                    if (state==0){
                        console.log(response.description);
                        return ;
                    }

                    this.gradeTypeArray = response.resData;
                    //debugger
                })
            },
            getGradeList : function () {
                var url = "${ctxPath}/happy-study/studentMan/editdata/baseinfo/add";
                var gradeType = this.pageParam.filter.gradeType;
                debugger
                if (gradeType != ""){
                    url = "${ctxPath}/happy-study/studentMan/list/gradeType/"+gradeType;
                }
                $.ajax({
                    url : url,
                    type : 'get',
                    async : false,
                    success : response=>{
                        var resData = response.resData
                        this.gradeArray = resData[0].gradeList;
                        debugger
                        console.log(this.gradeList);
                    }
                })
            },
        },
        mounted : function () {
            //加载学生基本信息
            this.listForm();
            //加载年级信息
            this.getGradeTypeList();
            this.getGradeList();
        }
    })

    layui.use('form', function () {
        var form = layui.form;

        form.on("select(sexSelect)", function(data){
            vue.pageParam.filter.sex = data.value;
            vue.listForm();
            //alert(data);
        })

        form.on("select(gradeTypeSelect)", function(data){
            vue.pageParam.filter.gradeType = data.value;
            vue.getGradeList();
            vue.listForm();
            vue.pageParam.filter.gradeId = vue.gradeArray[0].gradeId;
            vue.gradeType.typeCode = "";
            vue.gradeType.typeDescription = "";
            setTimeout(()=>{
                form.render();
            },50)
        })

        form.on("select(gradeSelect)", function(data){
            vue.pageParam.filter.gradeId = data.value;
            vue.gradeType.typeCode = data.value;
            var gradeArray = vue.gradeArray
            for (var i = 0; i < gradeArray.length; i++){
                if (gradeArray[i].gradeType.typeCode==data.value){
                    vue.gradeType.typeCode = data.value;
                    vue.gradeType.typeDescription = gradeArray[i].gradeType.typeDescription;
                }
            }
            vue.listForm();

            setTimeout(()=>{
                form.render();
            },50)
        })

        form.render();

    })

</script>