<style>
    .myTbhead {
        background: #393D49;
        color: #F0F0F0;
    }
    .man-container {
        margin-top: 10px;
    }

</style>

<div id="student-man" class="man-container">
    <!-- 表头按钮组 -->
    <div class="layui-row">

        <div class="layui-col-md6 layui-row">
            <div class="layui-col-md6" style="padding-right: 8px;">
                <input type="text" name="title" required lay-verify="required" placeholder="按姓名/学号搜索" autocomplete="off"
                       class="layui-input" id="filterInput">
            </div>
            <div class="layui-col-md5 layui-row">
                <div class="layui-col-md4" style="padding-left: 8px; padding-right: 4px;">
                    <form class="layui-form layui-inline">
                        <select name="sex"lay-search="">
                            <option value="">性别</option>
                            <option value="0">男</option>
                            <option value="1">女</option>
                        </select>
                    </form>
                </div>
                <div class="layui-col-md4" style="padding-left: 4px; padding-right: 8px">
                    <form class="layui-form layui-inline">
                        <select name="grade"lay-search="">
                            <option value="">初中/高中</option>
                            <option v-for="type in gradeTypeArray" :value="type.tpyeCode">{{type.typeDescription}}</option>
                        </select>
                    </form>
                </div>
                <div class="layui-col-md4" style="padding-left: 4px; padding-right: 8px">
                    <form class="layui-form layui-inline">
                        <select name="grade"lay-search="">
                            <option value="">年级</option>
                            <option>初一</option>
                            <option>初二</option>
                            <option>初三</option>
                            <option>高一</option>
                            <option>高二</option>
                            <option>高三</option>

                        </select>
                    </form>
                </div>
            </div>
            <div class="layui-col-md1">
                <button class="layui-btn">搜索</button>
            </div>
        </div>

        <div class="layui-col-md6 layui-row">
            <div class="layui-col-md-offset8" style="float:right;">
                <button class="layui-btn">导入</button>
                <button class="layui-btn" @click="openStuEditModal('add', null)">添加</button>
                <button class="layui-btn layui-btn-danger" @click="deleteBatch()">删除</button>
            </div>
        </div>

    </div>
    <!--表格 -->
    <div id="tablePane">
        <table class="layui-table" id="dataTable">
            <colgroup>
                <col width="50">
                <col width="150">
                <col width="150">
                <col width="150">
                <col width="150">
                <col width="150">
                <col width="150">
                <col width="150">
                <col width="150">
                <col>
                <col width="150">
            </colgroup>
            <thead class="myTbhead">
            <tr>
                <th class="myTbhead" id="headCheck">
                    <input type="checkbox" name="" lay-skin="primary" id="checkAll" style="text-align: center;" class="layui-form-checkbox"
                           v-model="stuCheck.isCheckAll" @change="checkAll()"></th>
                <th class="myTbhead">学号</th>
                <th class="myTbhead">姓名</th>
                <th class="myTbhead">性别</th>
                <th class="myTbhead">年龄</th>
                <th class="myTbhead">所在班级</th>
                <th class="myTbhead">班主任</th>
                <th class="myTbhead">所在年级</th>
                <th class="myTbhead">年级主任</th>
                <th class="myTbhead">备注</th>
                <th class="myTbhead">编辑</th>
            </tr>
            </thead>
            <tbody v-for="student in stuBaseInfo.infoArray">
            <tr>
                <td><input type="checkbox" name="" lay-skin="primary" class="layui-form-checkbox"
                           v-model="stuCheck.checkedValues" :value="student.id"></td>
                <td>{{student.sno}}</td>
                <td>{{student.name}}</td>
                <td>{{student.sex}}</td>
                <td>{{student.age}}</td>
                <td>{{student.clazzName}}</td>
                <td>{{student.clazzMasterName}}</td>
                <td>{{student.gradeName}}</td>
                <td>{{student.gradeMasterName}}</td>
                <td v-if="student.remark!=null&&student.remark!=''">{{student.remark}}</td>
                <td v-if="student.remark==null||student.remark==''">暂无</td>
                <td>
                    <button class="layui-btn layui-btn-sm" style="float: left;margin-left: 5%;"
                            @click="openStuEditModal('update', student)">修改</button>
                    <button class="layui-btn layui-btn-sm layui-btn-danger" style="float: right;margin-right: 5%;"
                            @click="deleteConfirm(student)">删除</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div>
        <table class="layui-hide" id="test"></table>
    </div>
    <!-- ./表格 -->
    <!-- 分页 -->
    <div style="text-align: center;">
        <div id="pagging"></div>
    </div>
    <!-- ./分页 -->


</div>

<script>

    var vue = new Vue({
        el : "#student-man",
        data : {
            stuBaseInfo : {
                infoArray : null,
                select : "",
            },
            stuEditModal : {
                show : false,
                actionType : "add", //add添加 update更新
            },
            gradeTypeArray : null,
            page : {
                current : 1,
            },
            tableActive : null,
            stuCheck : {
                isCheckAll : false,
                checkedValues : [],
            },
            pageParam : {
                currentPage : 1,
                pageSize : 5,
                pageSizeList : [5, 10, 20, 50],
                pageCount : "",
                totalCount : 0,
                pageBuffer : [],
                pageBeforeOmit : false,
                pageAffterOmit : true,
                orderBy : "asc",
                orderWay : "",
                filter : {
                    gradeType : "",
                    gradeId : "",
                },
                ext : [],
                isFirstTime : true,
            },
            layUI : {
                laypage : null,
            }

        },
        methods : {
            goToPage : function(page){
                if (page < 1){
                    alert("第一页了");
                    return ;
                }
                if (page > this.pageParam.pageCount){
                    alert("已经到底了");
                    return ;
                }
                this.pageParam.currentPage = page;
                this.listForm();
            },
            deleteBatch : function(){
                checkedValues = this.stuCheck.checkedValues;
                if (checkedValues == undefined || checkedValues == null || checkedValues.length == 0){
                    layer.msg("还未勾选删除的学生", {
                        icon : 3
                    });
                    return ;
                }

                var ids = "";
                for (var i = 0; i < checkedValues.length; i++){
                    ids += checkedValues[i]+"-";
                }
                var msg = "确认要删除学生 "+checkedValues.length+" 个 吗？"
                layer.confirm(msg, {
                    btn:['确定', '取消']
                }, function (index) {
                    layer.close(index);
                    vue.deleteSome(ids);
                }, function () {
                    alert("2");
                })
            },
            checkAll : function(){
                var array = this.stuBaseInfo.infoArray;
                //debugger
                if (array != null){
                    if (this.stuCheck.isCheckAll){
                        this.stuCheck.checkedValues = [];
                        for (var i = 0; i < array.length; i++){
                            this.stuCheck.checkedValues.push(array[i].id);
                        }
                    }else {
                        this.stuCheck.checkedValues = [];
                    }
                }
            },
            deleteSome : function(studentIdList){
                $.ajax({
                    url : "${ctxPath}/happy-study/studentMan/doEdit/baseinfo/delete",
                    type : "delete",
                    data : {studentIds : studentIdList},
                    async : false,
                    success : (response)=>{
                        if (response.state == 1){
                            vue.listForm();
                            layer.msg(response.description, {
                                end : function () {
                                },
                                icon : 1
                            });
                        }else if (response.state == 2) {
                            vue.listForm();
                            layer.msg(response.description, {
                                icon : 3
                            });
                        }else {
                            layer.msg(response.description, {
                                icon : 7
                            })
                        }
                    },
                    error : ()=>{
                        layer.msg("请求错误", {
                            icon : 2
                        });
                    }
                })
            },
            deleteConfirm : function(student){
                var msg = "确认要删除学生\r\n 学号:"+student.sno+"\r\n 姓名:"+student.name+"\r\n 吗？"
                layer.confirm(msg, {
                    btn:['确定', '取消']
                }, function (index) {
                    layer.close(index);
                    vue.deleteSome(student.id);
                }, function () {
                    //alert("2");
                })

            },
            openStuEditModal : function(actionType, student){
                var modalTitle = "";
                if (actionType == 'add'){
                    this.stuEditModal.actionType = actionType;
                    modalTitle = "添加学生";
                }else if (actionType == 'update'){
                    this.stuEditModal.actionType = actionType
                    modalTitle = "更新学生信息"
                }else{
                    return ;
                }
                layer.open({
                    type: 2,
                    title: modalTitle,
                    //content: $('#stuEditModal'),
                    content: ["${ctxPath}/happy-study/studentMan/editform/baseinfo/"+actionType, "no"], //获取html 不出现滚动条
                    area: ['700px', '500px'],
                    success: function (layero, index) {
                        //弹出成功后的回调
                        vue.stuEditModal.show = true;

                        if (student!=null){
                            if (student.sex=="女"){
                                student.sex = 1;
                            }else{
                                student.sex = 0;
                            }
                        }
                        //像子模块传递，子模块的vue写在这里面的，如果这类不掉用，子模块的vue无法加载
                        //！！！！！！注意！！！！！！
                        var iframe = window['layui-layer-iframe' + index];
                        iframe.child(student);
                        //debugger
                    },
                    end : function () {
                        //弹框销毁后刷新表格
                        vue.listForm();
                    }
                })
            },
            refreshCheckBox : function(){
                this.stuCheck.isCheckAll=false;
                this.stuCheck.checkedValues=[];
                this.stuBaseInfo.infoArray = null;
            },
            listForm : function () {
                this.refreshCheckBox();

                var pageParam = this.pageParam;

                var paginationParam = {
                    page : pageParam.currentPage,
                    pageSize : pageParam.pageSize,
                    orderBy : pageParam.orderBy,
                    orderWay : pageParam.orderWay,
                    totalCount : 0
                }
                var filter = {
                    gradeType : pageParam.filter.gradeType,
                    gradeId : pageParam.filter.gradeId,
                }
                if (this.stuBaseInfo==undefined){
                    debugger
                    pageParam.ext.push("");
                }else{
                    debugger
                    pageParam.ext.push(this.stuBaseInfo.select);
                }

                var ext = pageParam.ext;

                $.ajax({
                    type : "get",
                    url : "${ctxPath}/happy-study/studentMan/list",
                    async: false,
                    data : {paginationParam : paginationParam,
                        filter : filter,
                        ext : ext},
                    success : (response)=>{
                        var state = response.state;
                        if (state==0){
                            console.log(response.description);
                            return 0;
                        }
                        this.stuBaseInfo.infoArray = response.resData[0].resList;
                        this.pageParam.totalCount = response.resData[0].paginationParam.totalCount;
                        this.pageParam.pageCount = response.resData[0].paginationParam.pageCount;
                        console.log(this.stuBaseInfo.infoArray);

                        debugger
                        return this.pageParam.totalCount;
                    }
                })
                //debugger
                /*
                $.get("${ctxPath}/happy-study/studentMan/list", {
                        paginationParam : paginationParam,
                        filter : filter,
                        ext : ext}, response=>{
                    var state = response.state;
                    if (state==0){
                        console.log(response.description);
                        return 0;
                    }
                    this.stuBaseInfo.infoArray = response.resData[0].resList;
                    this.pageParam.totalCount = response.resData[0].paginationParam.totalCount;
                    this.pageParam.pageCount = response.resData[0].paginationParam.pageCount;
                    console.log(this.stuBaseInfo.infoArray);

                    return this.pageParam.totalCoun;
                    //this.updateNav(this.pageParam.totalCount)
                })
                */
            },
            initNav22 : function (){
                debugger
                layui.use(['laypage', 'layer', function () {
                    debugger
                    var laypage = layui.laypage;
                    var layer = layui.layer;
                    debugger

                    vue.pageParam.pageSize = vue.pageParam.pageSizeList[0];
                    vue.listForm();
                    debugger

                    //function toPages({
                    //    elem = 'pages',
                    //    curr = vue.pageParam.currentPage,
                    //    count = vue.pageParam.totalCount,
                    //    limit = vue.pageParam.pageSize,
                    //    limits = vue.pageParam.pageSizeList,
                    //    callBack = (obj, first)=>{}
                    //} = {}){
                    var elem = 'pages';
                    var curr = vue.pageParam.currentPage;
                    var count = vue.pageParam.totalCount;
                    var limit = vue.pageParam.pageSize;
                    var limits = vue.pageParam.pageSizeList;

                        laypage.render({
                            elem:elem, curr:curr, count:count, limit:limit, limits:limits,
                            first: "首页",
                            last: "尾页",
                            prev: "上一页",
                            next: "下一页",
                            layout: ['count', 'page', 'prev', 'next', 'limit', 'limits'],
                            jump: function (obj, first) {
                                debugger
                                //callBack(obj, first);
                            }
                        })
                    //}

                    //出发分页后的回调
                    /*
                    function reData(obj, first){
                        debugger
                        if (first === true){
                            debugger
                            return false;
                        }
                        debugger
                        res = vue.listForm();

                        toPages({
                            elem : 'pages',
                            curr : vue.pageParam.currentPage,
                            count : vue.pageParam.totalCount,
                            limit : vue.pageParam.pageSize,
                            limits : vue.pageParam.pageSizeList,
                            callBack : reData
                        })
                    }
                    */


                }])
                /*
                layui.use(['laypage', 'layer'], function () {
                    var laypage = layui.laypage;
                    var layer = layui.layer;
                    vue.layUI.laypage = laypage;

                    laypage.render({
                        elem: 'pagging',
                        limits : vue.pageParam.pageSizeList,
                        limit: vue.pageParam.pageSizeList[0],
                        layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip'],
                        jump: (obj)=> {
                            vue.listForm22(obj);
                            debugger;
                        }

                    });
                })
                */
            },
            initNav : function (){
                layui.use(['laypage', 'layer'], function () {
                    var laypage = layui.laypage;
                    var layer = layui.layer;
                    vue.layUI.laypage = laypage;
                    vue.listForm();
                    debugger
                    pages(vue.pageParam.totalCount,
                        vue.pageParam.pageSizeList,
                        vue.pageParam.pageSizeList[0],
                        vue.pageParam.pageCount,
                        vue.pageParam.currentPage, reload)

                    function pages(count,
                                   limits,
                                   limit,
                                   pages,
                                   curr,
                                   callback=(obj, first) =>{}){
                        debugger
                        laypage.render({
                            elem: 'pagging',
                            count: count, //数据总数
                            limits: limits,
                            limit: limit,
                            //count: vue.pageParam.totalCount,
                            pages: pages,
                            curr: curr,
                            layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip'],
                            jump: (obj, first) => {
                                debugger
                                //var first = vue.pageParam.isFirstTime;
                                callback(obj, first)
                                debugger
                                return false;
                                debugger
                                //obj.pages = vue.pageParam.pageCount;

                            }
                        })
                    }


                    function reload(obj, first){
                        if (first==true){
                            //vue.pageParam.isFirstTime = false;
                            debugger
                            return false;
                        }
                        debugger
                        var curr = obj.curr;
                        if (vue.pageParam.pageSize !== obj.limit){
                            vue.pageParam.currentPage = 1;
                            vue.pageParam.pageSize = obj.limit;
                        }else{
                            vue.pageParam.currentPage = curr;
                        }

                        debugger
                        //vue.pageParam.pageSize = obj.limit;
                        vue.listForm();

                        //var totalCount = vue.pageParam.totalCount;
                        //var pageSizeList = vue.pageParam.pageSizeList;
                        //var pageSize = vue.pageParam.pageSize;
                        //var pageCount = vue.pageParam.pageCount
                        //var currentPage = vue.pageParam.currentPage

                        debugger
                        //obj.count = vue.pageParam.totalCount;
                        pages(vue.pageParam.totalCount,
                            vue.pageParam.pageSizeList,
                            vue.pageParam.pageSize,
                            vue.pageParam.pageCount,
                            vue.pageParam.currentPage, reload)

                    }
                        /**
                         * first: '首页',
                         last: '尾页',
                         prev: '<em>←</em>',
                         next: '<em>→</em>'
                         */
                })
            },
            listGradeType : function () {
                $.get("${ctxPath}/happy-study/studentMan/list/gradeType", {}, response=>{
                    var state = response.state;
                    if (state==0){
                        console.log(response.description);
                        return ;
                    }
                    this.gradeTypeArray = response.resData;
                    console.log(vue.gradeTypeArray);
                })
            }
        },
        mounted : function () {
            //加载学生基本信息
            //this.listForm();
            debugger
            //初始化分页
            this.initNav();
            //加载年级信息
            this.listGradeType();
        }
    })

    layui.use('form', function () {
        var form = layui.form;
        form.render();
    })
</script>