<!-- jQuery 3 -->
<script type="text/javascript" src="${ctxPath}/frame/jquery/jquery-3.4.1.js"></script>
<!-- vue -->
<script type="text/javascript" src="${ctxPath}/frame/vue/vue.min.js"></script>
<!-- layui -->
<script src="${ctxPath}/frame/layui-v2.5.7/layui/layui.js"></script>
<link rel="stylesheet" href="${ctxPath}/frame/layui-v2.5.7/layui/css/layui.css">

<!-- 添加/修改科目基本信息 -->
<div style="padding-top: 20px;">
    <p id="actionTag" hidden>${action}</p>
    <div id="subjectEditModal">
        <form class="layui-form" action="" lay-filter="subjectEditForm">
            <div class="layui-form-item">
                <label class="layui-form-label">科目名称</label>
                <div class="layui-input-block" style="width: 45%;">
                    <input type="text" name="subjectName" required lay-verify="required|name" placeholder="科目名称" autocomplete="off"
                           class="layui-input" v-model="subjectName">
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">科目类型</label>
                    <div class="layui-input-inline"><select name="subjectType" lay-verify="required" lay-search="" id="subjectTypeSelect" lay-filter="subjectTypeSelect">
                        <option value="" v-if="subjectType==null">年级类型列表</option>
                        <option :value="subjectType.typeCode" v-if="subjectType!=null">{{subjectType.typeDescription}}</option>
                        <option v-for="type in subjectTypeList" :value="type.typeCode">{{type.typeDescription}}</option>
                    </select></div>
                </div>
            </div>
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;margin-bottom: 30px;">
                <legend></legend>
            </fieldset>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block" style="width: 500px;">
                    <textarea name="remark" placeholder="请输入内容" class="layui-textarea" v-model="remark"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="subjectEdit" >立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>

    </div>

</div>

<script>
    function child(subject) {
        var formVue = new Vue({
            el : "#subjectEditModal",
            data : {
                form : null,
                actionType : null,
                id : null,
                subjectTypeList : null,
                subjectType : null,
                subjectTypeCode : "",
                subjectName : "",
                remark : "",
            },
            methods : {
                getSubjectTypeList : function(){
                    $.get("${ctxPath}/happy-study/subjectMan/list/subjectType", {}, response=>{
                        var state = response.state;
                        if (state==0){
                            console.log(response.description);
                            return ;
                        }

                        this.subjectTypeList = response.resData;
                    })
                },
                loadSubject : function (subject) {
                    if (subject!=undefined && subject!=null){
                        this.id = subject.id;
                        this.subjectName = subject.subjectName;
                        this.subjectType = subject.subjectType;
                        this.subjectTypeCode = subject.subjectType.typeCode;
                    }
                }

            },
            mounted : function () {
                this.actionType = $("#actionTag").text();

                this.getSubjectTypeList();
                this.loadSubject(subject)
            }
        })

        function renderForm(){
            layui.use('form', function () {
                var form = layui.form;
                form.render();
            })
        }

        layui.use(['form', 'layedit', 'laydate'], function () {
            var form = layui.form
                ,layer = layui.layer
                ,layedit = layui.layedit
                ,laydate = layui.laydate;

            formVue.form = form;

            //注册select框
            form.on('select(subjectTypeSelect)', function(data){
                formVue.subjectTypeCode = data.value;
            })

            form.on("submit(subjectEditForm)", function(data){
                var subjectName = formVue.subjectName;
                var subjectType = formVue.subjectTypeCode;
                var remark = formVue.remark;
                var id = formVue.id;

                var dataParam = {
                    id : id,
                    subjectName : subjectName,
                    subjectType : subjectType,
                    remark : remark,
                }

                $.ajax({
                    url : "${ctxPath}/happy-study/subjectMan/doEdit/baseinfo/"+formVue.actionType,
                    type : "post",
                    data : JSON.stringify(dataParam),
                    contentType : "application/json;charset=utf-8",
                    async : false,
                    success : response=>{
                        layer.msg(response.description, {
                            end : function(){

                            }
                        })

                        setTimeout(()=>{
                            parent.layer.closeAll('iframe');
                        }, 1500)
                    },
                    error : ()=>{
                        layer.msg("请求失败", {icon : 5});
                    }
                })

                return false;
            })

            form.verify({
                name: function(value){
                    if(value.length < 2){
                        return '名字至少2字';
                    }
                }
                ,pass: [
                    /^[\S]{6,12}$/
                    ,'密码必须6到12位，且不能出现空格'
                ]

            })
        })

    }

</script>