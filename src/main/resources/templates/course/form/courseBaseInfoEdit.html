<!-- jQuery 3 -->
<script type="text/javascript" src="${ctxPath}/frame/jquery/jquery-3.4.1.js"></script>
<!-- vue -->
<script type="text/javascript" src="${ctxPath}/frame/vue/vue.min.js"></script>
<!-- layui -->
<script src="${ctxPath}/frame/layui-v2.5.7/layui/layui.js"></script>
<link rel="stylesheet" href="${ctxPath}/frame/layui-v2.5.7/layui/css/layui.css">

<!-- 添加/修改课程基本信息 -->
<div style="padding-top: 20px;">
    <p id="actionTag" hidden>${action}</p>
    <div id="courseEditModal">
        <form class="layui-form" action="" lay-filter="courseEditForm">
            <div class="layui-form-item">
                <div class="layui-form-item">
                    <div class="layui-block">
                        <label class="layui-form-label">授课教师</label>
                        <div class="layui-input-inline">
                            <select name="teacherId" lay-verify="required" lay-search="" id="teacherSelect" lay-filter="teacherSelect"
                            >
                                <option value="" v-if="teacherId==''">获取教师列表</option>
                                <option :value="teacherId" v-if="teacherId!=''">{{teacherName}}</option>
                                <option v-for="teacher in teacherList" :value="teacher.id">{{teacher.name}}</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">科目类别</label>
                    <div class="layui-input-inline"><select name="subjectType" lay-verify="required" lay-search="" id="subjectTypeSelect" lay-filter="subjectTypeSelect">
                        <option value="" v-if="subjectType.typeCode==null">科目类别列表</option>
                        <option :value="subjectType.typeCode" v-if="subjectType.typeCode!=null">{{subjectType.typeDescription}}</option>
                        <option v-for="type in subjectTypeList" :value="type.typeCode">{{type.typeDescription}}</option>
                    </select></div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">选择科目</label>
                    <div class="layui-input-inline"><select name="subjectId" lay-verify="required" lay-search="" id="subjectSelect" lay-filter="subjectSelect">
                        <option value="" v-if="subjectId==''">科目列表</option>
                        <option :value="subjectId" v-if="subjectId!=''">{{subjectName}}</option>
                        <option v-for="sub in subjectList" :value="sub.id" v-if="subjectName==''">{{sub.subjectName}}</option>
                    </select></div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">选择年级</label>
                    <div class="layui-input-inline">
                        <select name="gradeId" lay-verify="required" lay-search="" id="gradeSelect" lay-filter="gradeSelect"
                        >
                            <option value="" v-if="gradeId==''">获取年级列表</option>
                            <option :value="gradeId" v-if="gradeId!=''">{{gradeName}}</option>
                            <option v-for="grade in gradeList" :value="grade.id">{{grade.gradeName}}</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">选择班级</label>
                    <div class="layui-input-inline"><select name="clazzId" disabled lay-verify="required" lay-search="" id="clazzSelect" lay-filter="clazzSelect">
                        <option value="" v-if="clazzId==''">请先选择年级</option>
                        <option :value="clazzId" v-if="clazzId!=''">{{clazzName}}</option>
                        <option v-for="clazz in clazzList" :value="clazz.id">{{clazz.clazzName}}</option>
                    </select></div>
                </div>

            </div>
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;margin-bottom: 30px;">
                <legend></legend>
            </fieldset>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block" style="width: 500px;">
                    <textarea name="remark" placeholder="请输入内容" class="layui-textarea" v-model="remark"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="courseEdit" >立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>

</div>

<script>
    function child(course){
        var formVue = new Vue({
            el : "#courseEditModal",
            data : {
                layForm : null,
                actionType : null,
                clazzList : null,
                subjectList : null,
                subjectTypeList : null,
                teacherList : null,
                gradeList : null,
                gradeId : "",
                gradeName : "",
                subjectType : {
                    typeDescription : "",
                    typeCode : null,
                },
                id : null,
                subjectName : "",
                subjectId : "",
                clazzName : "",
                clazzId : "",
                teacherName : "",
                teacherId : "",
                remark : "",
                isFirst : true,
            },
            methods : {
                getSubjectTypeBySubject(subjectId){
                    //debugger
                    $.ajax({
                        url : "${ctxPath}/happy-study/subjectMan/query/subjectType/"+subjectId,
                        data : {},
                        type : "get",
                        async : false,
                        success : response=>{
                            var state = response.state;
                            this.subjectType.typeCode = response.resData[0].typeCode
                            this.subjectType.typeDescription = response.resData[0].typeDescription;
                            console.log(formVue.subjectType);
                            this.getSubjectList(formVue.subjectType.typeCode);
                            //debugger
                        }
                    });

                },
                getSubjectTypeList : function(){
                    $.ajax({
                        url : "${ctxPath}/happy-study/subjectMan/list/subjectType",
                        data : {},
                        type : "get",
                        async : false,
                        success : response=>{
                            var state = response.state;
                            if (state==0){
                                console.log(response.description);
                                return ;
                            }

                            this.subjectTypeList = response.resData;
                        }
                    })
                    /*
                    $.get("${ctxPath}/happy-study/subjectMan/list/subjectType", {}, response=>{
                        var state = response.state;
                        if (state==0){
                            console.log(response.description);
                            return ;
                        }

                        this.subjectTypeList = response.resData;
                        //debugger
                    })
                    */
                },
                getSubjectList : function(subjectType){
                    if (subjectType == null){
                        subjectType = "";
                    }
                    //debugger
                    $.ajax({
                        url : "${ctxPath}/happy-study/subjectMan/list/-"+subjectType,
                        data : {},
                        type : "get",
                        async : false,
                        success : response=>{
                            var state = response.state;
                            if (state==0){
                                console.log(response.description);
                                return ;
                            }
                            this.subjectList = response.resData;
                            //debugger
                        }
                    });
                },
                getGradeList : function(){
                    $.ajax({
                        url : "${ctxPath}/happy-study/studentMan/editdata/baseinfo/add",
                        type : 'get',
                        async : false,
                        success : response=>{
                            var resData = response.resData
                            this.gradeList = resData[0].gradeList;
                            console.log(this.gradeList);
                        }
                    })
                },
                getClazzList : function(gradeId){
                    if (gradeId==undefined || gradeId==null || gradeId==""){
                        return ;
                    }
                    $.ajax({
                        url : "${ctxPath}/happy-study/studentMan/editdata/baseinfo/add/"+gradeId,
                        type : 'get',
                        async : false,
                        success : (response)=>{
                            var resData = response.resData;
                            console.log(resData);
                            this.clazzList = resData[0].clazzList;
                            //debugger
                        }
                    })
                },
                getCourseAbleTeacherList : function () {
                    $.ajax({
                        url : "${ctxPath}/happy-study/courseMan/list/courseAbleTeacher",
                        type : 'get',
                        async : false,
                        success : response=>{
                            var state = response.state;
                            this.teacherList = response.resData;
                        }
                    })
                    //$.get("${ctxPath}/happy-study/courseMan/list/courseAbleTeacher", {}, response=>{
                    //    var state = response.state;
                    //    this.teacherList = response.resData;
                    //})
                },
                loadCourse : function (course) {
                    if (course!=undefined&&course!=null){
                        this.id = course.id;
                        this.remark = course.remark;
                        this.teacherId = course.teacherId;
                        this.teacherName = course.teacherName;
                        $("#clazzSelect").attr("disabled", "disabled");
                        $("#gradeSelect").attr("disabled", "disabled");
                        $("#subjectSelect").attr("disabled", "disabled");
                        $("#subjectTypeSelect").attr("disabled", "disabled");
                        $("#clazzSelect").removeAttr("lay-verify");
                        $("#gradeSelect").removeAttr("lay-verify");
                        $("#subjectSelect").removeAttr("lay-verify");
                        $("#subjectTypeSelect").removeAttr("lay-verify");

                    }
                }
            },
            mounted : function(){
                this.actionType = $("#actionTag").text();
                console.log(this.actionType);

                var subjectType = this.subjectType.typeCode;
                this.getSubjectList(subjectType);
                this.getSubjectTypeList();
                this.getGradeList();
                this.getClazzList();
                this.getCourseAbleTeacherList();
                this.loadCourse(course);
            }
        })

        function renderForm(){
            layui.use('form', function () {
                var form = layui.form;
                form.render();
            })
        }

        layui.use(['form', 'layedit', 'laydate'], function (){
            var form = layui.form
                ,layer = layui.layer
                ,layedit = layui.layedit
                ,laydate = layui.laydate;

            formVue.layForm = form;

            //注册select框
            form.on('select(gradeSelect)', function(data){
                formVue.gradeId = data.value;
                //form.render();
                formVue.getClazzList(formVue.gradeId);

                if (formVue.gradeId==''){
                    $("#clazzSelect").attr("disabled", "disabled");
                }else{
                    $("#clazzSelect").removeAttr("disabled");
                }

                setTimeout(()=>{
                    form.render();
                }, 50)
            })
            form.on('select(subjectTypeSelect)', function (data) {
                formVue.subjectType.typeCode = data.value;
                if (formVue.subjectId!=""){
                    formVue.subjectId = "";
                    formVue.subjectName = "";
                }

                formVue.getSubjectList(formVue.subjectType.typeCode);
                setTimeout(()=>{
                    form.render();
                }, 50)
            })
            form.on("select(subjectSelect)", function (data) {
                formVue.subjectId = data.value;
                formVue.subjectName = "";
                //debugger;

                if (formVue.subjectType.typeCode==null){
                    formVue.getSubjectTypeBySubject(formVue.subjectId);
                    var subjectList = formVue.subjectList;
                    for (var i = 0; i < subjectList.length; i++){
                        if (subjectList[i].id==formVue.subjectId){
                            formVue.subjectName = subjectList[i].subjectName;
                        }
                    }
                    console.log(formVue.subjectId);
                    debugger
                    setTimeout(()=>{
                        form.render();
                    }, 50)
                    console.log(formVue.subjectId);
                    debugger
                }

            })
            form.on("select(clazzSelect)", function (data) {
                formVue.clazzId = data.value;
            })
            form.on("select(teacherSelect)", function (data) {
                formVue.teacherId = data.value;
            })

            form.on("submit(courseEditForm)", function (data) {
                var id = formVue.id;
                var subjectName = formVue.subjectName;
                var subjectId = formVue.subjectId;
                var clazzName = formVue.clazzName;
                var clazzId = formVue.clazzId;
                var teacherName = formVue.teacherName;
                var teacherId = formVue.teacherId;
                var remark = formVue.remark;

                var dataParam = {
                    id : id,
                    subjectId : subjectId,
                    clazzId : clazzId,
                    teacherId : teacherId,
                    remark : remark
                }
                if (formVue.actionType=="update"){
                    dataParam = {
                        id : id,
                        teacherId : teacherId,
                        remark : remark
                    }
                }


                $.ajax({
                    url : "${ctxPath}/happy-study/courseMan/doEdit/baseinfo/"+formVue.actionType,
                    type : "post",
                    data : JSON.stringify(dataParam),
                    contentType: "application/json;charset=utf-8",
                    async : false,
                    success : (response)=>{
                        layer.msg(response.description, {
                            end : function () {
                                if (response.state==1){
                                    console.log("消息框已关闭");
                                }
                            }
                        });

                        setTimeout(()=>{
                            parent.layer.closeAll('iframe');
                        }, 1500)
                        /**
                         * layer.msg(response.description+response.state, function(){
                        if (response.state==1){
                            layer.closeAll(2);
                            console.log("!!!")
                        }
                    });
                         */
                    },
                    error : ()=>{
                        layer.msg("请求失败", {icon: 5});
                    }
                });

                return false;
            })

            //自定义验证规则
            form.verify({
                name: function(value){
                    if(value.length < 2){
                        return '名字至少2字';
                    }
                }
                ,pass: [
                    /^[\S]{6,12}$/
                    ,'密码必须6到12位，且不能出现空格'
                ]
                ,content: function(value){
                    layedit.sync(editIndex);
                }
            });
        })
    }
</script>