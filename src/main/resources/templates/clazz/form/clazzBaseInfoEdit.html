<!-- jQuery 3 -->
<script type="text/javascript" src="${ctxPath}/frame/jquery/jquery-3.4.1.js"></script>
<!-- vue -->
<script type="text/javascript" src="${ctxPath}/frame/vue/vue.min.js"></script>
<!-- layui -->
<script src="${ctxPath}/frame/layui-v2.5.7/layui/layui.js"></script>
<link rel="stylesheet" href="${ctxPath}/frame/layui-v2.5.7/layui/css/layui.css">

<!-- 添加/修改班级基本信息 -->
<div style="padding-top: 20px;">
    <p id="actionTag" hidden>${action}</p>
    <div id="clazzEditModal">
        <form class="layui-form" action="" lay-filter="clazzEditForm">

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">班级名称</label>
                    <div class="layui-input-inline"><input type="text" name="name" required lay-verify="required|name" placeholder="年级名称" autocomplete="off"
                           class="layui-input" v-model="name"></div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">班级类型</label>
                    <div class="layui-input-inline"><select name="clazzType" lay-verify="required" lay-search="" id="clazzTypeSelect" lay-filter="clazzTypeSelect">
                        <option value="" v-if="clazzType.typeCode==''">选择班级类型</option>
                        <option :value="gradeId" v-if="clazzType.typeCode!=''">{{clazzType.typeDescription}}</option>
                        <option v-for="type in clazzTypeList" :value="type.typeCode">{{type.typeDescription}}</option>
                    </select></div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">所属年级</label>
                    <div class="layui-input-inline"><select name="gradeId" lay-verify="required" lay-search="" id="gradeSelect" lay-filter="gradeSelect">
                        <option value="" v-if="gradeId==''">年级列表</option>
                        <option :value="gradeId" v-if="gradeId!=''">{{gradeName}}</option>
                        <option v-for="grade in gradeList" :value="grade.id">{{grade.gradeName}}</option>
                    </select></div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">选择班主任</label>
                    <div class="layui-input-inline">
                        <select name="teacherId" lay-verify="required" lay-search="" id="teacherSelect" lay-filter="teacherSelect"
                        >
                            <option value="" v-if="clazzMasterId==''">获取教师列表</option>
                            <option :value="clazzMasterId" v-if="clazzMasterId!=''">{{clazzMasterName}} - {{clazzMasterNo}}</option>
                            <option v-for="teacher in teacherList" :value="teacher.id">{{teacher.name}} - {{teacher.tno}}</option>
                        </select>
                    </div>
                </div>
            </div>
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;margin-bottom: 30px;">
                <legend></legend>
            </fieldset>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block" style="width: 500px;">
                    <textarea name="remark" placeholder="请输入内容" class="layui-textarea" v-model="remark"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="clazzEdit" >立即提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function child(clazz){
        var formVue = new Vue({
            el : "#clazzEditModal",
            data : {
                form : null,
                actionType : null,
                gradeList : null,
                teacherList : null,
                clazzTypeList : null,
                id : null,
                name : "",
                gradeId : "",
                gradeName : "",
                clazzType : {
                    typeCode : "",
                    typeDescription : "",
                },
                clazzMasterId : "",
                clazzMasterNo : "",
                clazzMasterName : "",
                remark : "",
            },
            methods : {
                getClazzList : function(){
                    $.ajax({
                        url : "${ctxPath}/happy-study/clazzMan/list/clazzType",
                        data : {},
                        async : false,
                        success : response=>{
                            var state = response.state;
                            this.clazzTypeList = response.resData;
                        }
                    })
                },
                getGradeList : function () {
                    $.ajax({
                        url : "${ctxPath}/happy-study/studentMan/editdata/baseinfo/add",
                        type : 'get',
                        async : false,
                        success : response=>{
                            var resData = response.resData
                            this.gradeList = resData[0].gradeList;
                            console.log(this.gradeList);
                        }
                    })
                },
                getTeacherList : function(){
                    $.ajax({
                        url : "${ctxPath}/happy-study/clazzMan/editdata/baseinfo/listClazzMasterAbleTeacher",
                        type : 'get',
                        async : false,
                        success : (response)=>{
                            var resData = response.resData;
                            console.log(resData);
                            this.teacherList = resData;
                            //debugger
                        }
                    })
                },
                loadClazz : function(clazz){
                    //debugger
                    if (clazz != undefined && clazz != null){
                        //debugger
                        this.id = clazz.id;
                        this.name = clazz.clazzName;
                        this.gradeId = clazz.gradeId;
                        this.gradeName = clazz.gradeName;
                        this.clazzType.typeCode = clazz.clazzType.typeCode;
                        this.clazzMasterId = clazz.clazzMasterId;
                        //TODO this.clazzMasterNo = clazz.clazzMasterNo;
                        this.clazzMasterName = clazz.clazzMasterName;
                        this.remark = clazz.remark;
                    }
                }
            },
            mounted : function(){
                this.actionType = $("#actionTag").text();

                this.getClazzList();
                this.getGradeList();
                this.getTeacherList();
                this.loadClazz(clazz);
            }
        })

        function renderForm() {
            layui.use('form', function () {
                var form = layui.form;
                form.render();
            })
        }

        layui.use(['form', 'layedit', 'laydate'], function (){
            var form = layui.form
                ,layer = layui.layer
                ,layedit = layui.layedit
                ,laydate = layui.laydate;

            formVue.form = form;

            form.on('select(clazzTypeSelect)', function (data) {
                formVue.clazzType.typeCode = data.value;
            })

            //注册select框
            form.on('select(gradeSelect)', function(data){
                formVue.gradeId = data.value;
                //form.render();
            })
            //注册select框
            form.on('select(teacherSelect)', function(data){
                formVue.clazzMasterId = data.value;
                //form.render();
            })

            form.on("submit(clazzEditForm)", function(data){
                var id = formVue.id;
                var clazzName = formVue.name;
                var gradeId = formVue.gradeId;
                var clazzType = formVue.clazzType.typeCode;
                var clazzMasterId = formVue.clazzMasterId;
                var remark = formVue.remark;

                var dataParam = {
                    id : id,
                    clazzName : clazzName,
                    gradeId : gradeId,
                    clazzType : clazzType,
                    clazzMasterId : clazzMasterId,
                    remark : remark,
                }
                //debugger

                $.ajax({
                    url : "${ctxPath}/happy-study/clazz" +
                        "Man/doEdit/baseinfo/"+formVue.actionType,
                    type : "post",
                    data : JSON.stringify(dataParam),
                    contentType : "application/json;charset=utf-8",
                    async : false,
                    success : response=>{
                        layer.msg(response.description, {
                            end : function(){

                            }
                        })

                        setTimeout(()=>{
                            parent.layer.closeAll('iframe');
                        }, 1500)
                    },
                    error : ()=>{
                        layer.msg("请求失败", {icon : 5});
                    }
                })

                return false;
            })

            form.verify({
                name: function(value){
                    if(value.length < 2){
                        return '名字至少2字';
                    }
                }
                ,pass: [
                    /^[\S]{6,12}$/
                    ,'密码必须6到12位，且不能出现空格'
                ]

            })

        })

    }
</script>